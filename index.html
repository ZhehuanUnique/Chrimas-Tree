<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>手势控制粒子圣诞树</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="video-container">
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas"></canvas>
            <div class="overlay">
                <div class="status" id="status">正在请求摄像头权限...</div>
                <div class="instructions">
                    <p>张开5指：生成粒子</p>
                    <p>收紧5指：清除粒子</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MediaPipe Hands - 动态加载 -->
    <script>
        // 动态加载 MediaPipe 库
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = () => reject(new Error(`Failed to load ${src}`));
                document.head.appendChild(script);
            });
        }

        // 按顺序加载 MediaPipe 库
        async function loadMediaPipe() {
            const cdnBase = 'https://cdn.jsdelivr.net/npm';
            const fallbackBase = 'https://unpkg.com';
            
            const libraries = [
                { name: 'hands', path: '@mediapipe/hands@0.4.1675469404/hands.js', alt: '@mediapipe/hands@0.4.1675469404' },
                { name: 'camera_utils', path: '@mediapipe/camera_utils@0.3.1675466867/camera_utils.js', alt: '@mediapipe/camera_utils@0.3.1675466867' },
                { name: 'drawing_utils', path: '@mediapipe/drawing_utils@0.3.1620248257/drawing_utils.js', alt: '@mediapipe/drawing_utils@0.3.1620248257' }
            ];

            for (const lib of libraries) {
                let loaded = false;
                // 尝试多个路径
                const paths = [lib.path, lib.alt];
                
                for (const path of paths) {
                    try {
                        await loadScript(`${cdnBase}/${path}`);
                        console.log(`Loaded ${lib.name} from jsdelivr`);
                        loaded = true;
                        break;
                    } catch (error) {
                        console.warn(`Failed to load ${lib.name} from jsdelivr with path ${path}`);
                    }
                }
                
                if (!loaded) {
                    // 尝试备用 CDN
                    for (const path of paths) {
                        try {
                            await loadScript(`${fallbackBase}/${path}`);
                            console.log(`Loaded ${lib.name} from unpkg`);
                            loaded = true;
                            break;
                        } catch (error) {
                            console.warn(`Failed to load ${lib.name} from unpkg with path ${path}`);
                        }
                    }
                }
                
                if (!loaded) {
                    throw new Error(`Failed to load ${lib.name} from all CDNs and paths`);
                }
            }
        }

        // 加载 MediaPipe 然后加载应用脚本
        loadMediaPipe()
            .then(() => {
                console.log('MediaPipe libraries loaded successfully');
                // 加载应用脚本
                const scripts = ['particle-tree.js', 'hand-gesture.js', 'main.js'];
                let loaded = 0;
                scripts.forEach(src => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.onload = () => {
                        loaded++;
                        if (loaded === scripts.length) {
                            console.log('All scripts loaded');
                        }
                    };
                    document.body.appendChild(script);
                });
            })
            .catch(error => {
                console.error('Failed to load MediaPipe:', error);
                const status = document.getElementById('status');
                if (status) {
                    status.textContent = 'MediaPipe 库加载失败，请检查网络连接或刷新页面';
                }
            });
    </script>
</body>
</html>

